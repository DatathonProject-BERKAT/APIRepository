<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Butterscotch</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="static/style.css">
</head>

<body>
  <header>
    <h1>Behavioral Maze Analyzer</h1>
  </header>

  <nav>
    <a href="#" class="active">Radial Arm Maze</a>
    <a href="#">About</a>
  </nav>

  <div class="section">
    <form id="uploadForm" enctype="multipart/form-data">
      <h2>Experiment Metadata</h2>
      <label>Batch Name:</label><input type="text" name="batch_name" required>
      <label>Date:</label><input type="date" name="day" >
      <label>Basin Diameter (cm):</label><input type="number" name="diameter">
      <label>Rat Length (cm):</label><input type="number" name="rat_length">

      <label>Upload Experiment Folders:</label>
      <button type="button" style="width:50px; margin:10px 1px;" onclick="addFolderInput()">+</button>
      <div id="folder_input"></div>
        
      <button id="uploadButton" type="submit">Upload Video</button>  
    </form>
  </div>

  <script>
    let counter = 0;

    function addFolderInput() {
      const list = document.getElementById("folder_input");
      const div = document.createElement('div');
      const id = `div${counter}`;
      div.id = id;

      div.innerHTML = `
        <label>Folder Name:</label>
        <input type="text" name="folder_name_${counter}" placeholder="Name">
        <input type="file" name="folder" webkitdirectory directory multiple>
        <button type="button" style="background-color:#E62323; cursor:pointer; width:20%; margin:10px 1px;" onclick="deleteFolderInput('${id}')">Delete</button>
      `;
      list.appendChild(div);
      counter++;
    }

    function deleteFolderInput(folderInputId) {
      const folder = document.getElementById(folderInputId);
      if (folder) folder.remove();
    }

    document.getElementById("uploadForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        const formData = new FormData();
        const folderInputs = document.querySelectorAll('input[type="file"][name="folder"]');
        let hasFiles = false;

        const batchName = document.querySelector('[name="batch_name"]').value.trim()+" ; "+getTimestamp() || "unnamed_batch";

        folderInputs.forEach((input, index) => {
        const folderNameInput = input.parentElement.querySelector('input[type="text"]');
        const folderName = folderNameInput?.value || `folder_${index}`;

        Array.from(input.files).forEach((file) => {
            hasFiles = true;
            const relativePath = file.webkitRelativePath.split('/').slice(1).join('/');
            formData.append("videos", file, `${batchName}/${folderName}/${relativePath}`);
        });
        
      });


        if (!hasFiles) {
            alert("Please select at least one folder.");
            return;
        }

        // Metadata (batch_name, date, etc.)
        ["batch_name", "day", "diameter", "rat_length"].forEach(name => {
            const value = document.querySelector(`[name="${name}"]`)?.value;
            if (value) formData.append(name, value);
        });

        try {
            const res = await fetch("/upload", {
            method: "POST",
            body: formData,
            });

            if (res.ok) {
                alert("upload success full")
            } else {

            }
        } catch (error) {
            console.error("Upload error:", error);
            alert("Upload error. See console.");
        }
        });

        function getTimestamp() {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');

            const year = now.getFullYear();
            const month = pad(now.getMonth() + 1);
            const day = pad(now.getDate());
            const hour = pad(now.getHours());
            const minute = pad(now.getMinutes());
            const second = pad(now.getSeconds());

            return `${year}${month}${day}${hour}${minute}${second}`;
            }

  </script>
</body>
</html>
